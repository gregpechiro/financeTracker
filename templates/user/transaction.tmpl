<!DOCTYPE html>
<html>
    <head>
        {{ template "head.tmpl" . }}

        <link rel="stylesheet" href="/static/css/datatables-bootstrap.css">
        <link rel="stylesheet" href="/static/css/datatables-custom.css">

        <title>Dashboard</title>

    </head>
    <body>

        {{ template "navbar.tmpl" . }}

        <div class="container">
            <div class="row">
                <div class="col-lg-2 col-xs-2">
                    <label>Time</label>
                    <select class="form-control filter" name="time">
                        <option value="week">One Week</option>
                        <option value="">One Month</option>
                        <option value="3months">3 Months</option>
                        <option value="6months">6 Months</option>
                        <option value="12months">Year</option>
                        <option value="all">All</option>
                    </select>
                </div>
                <div class="col-lg-2 col-xs-2">
                    <label>Ammount Type</label>
                    <select id="aType-filter" class="form-control filter" name="aType">
                        <option value="">All</option>
                        <option value="income">Income</option>
                        <option value="expense">Expense</option>
                    </select>
                </div>
                <div class="col-lg-2 col-xs-2">
                    <label>Who</label>
                    <select id="who" class="form-control filter" name="who">
                        <option value="">All</option>
                        {{ range $who := OrderCategories .user.People }}
                            <option value="{{ Title $who }}">{{ Title $who }}</option>
                        {{ end }}
                    </select>
                </div>
                <div class="col-lg-2 col-xs-2">
                    <label>Category 1</label>
                    <select id="category1" class="form-control filter" name="category1">
                        <option value="">All</option>
                        {{ range $category := OrderCategories .user.Categories }}
                            <option value="{{ Title $category }}">{{ Title $category }}</option>
                        {{ end }}
                    </select>
                </div>
                <div class="col-lg-2 col-xs-2">
                    <label>Category 2</label>
                    <select id="category2" class="form-control filter" name="category2">
                        <option value=""></option>
                    </select>
                </div>
                <div class="col-lg-2 col-xs-2">
                    <label></label>
                    <select class="form-control" name="">
                        <option value=""></option>
                    </select>
                </div>
            </div>
            <br>
            <div class="row">
                <div class="col-lg-12 col-xl-12">
                    <div class="panel panel-default">
                        <div class="panel-heading clearfix">
                            All Transactions
                            <button class="btn btn-xs btn-default pull-right" data-toggle="modal" data-target="#transactionModal">Add</button>
                        </div>
                        <div class="panel-body">
                            {{ if .transactions }}
                                <table id="transactions" class="table table-bordered table-hover" width="100%">
                                    <thead>
                                        <tr id="search">
                                            <th>date</th>
                                            <th>title</th>
                                            <th>expense</th>
                                            <th>income</th>
                                            <th>who</th>
                                            <th>category</th>
                                            <th>secondaryCategory</th>
                                        </tr>
                                        <tr>
                                            <th>Date</th>
                                            <th>Title</th>
                                            <th>Expense</th>
                                            <th>Income</th>
                                            <th>Who</th>
                                            <th>Category</th>
                                            <th>Secondary Category</th>
                                        </tr>
                                    </thead>
                                    <tfoot>
                                        <tr>
                                            <th colspan="2"></th>
                                            <th class="text-right"></th>
                                            <th class="text-right"></th>
                                            <th colspan="3"></th>
                                        </tr>
                                    </tfoot>
                                    <tbody>
                                        {{ range $transaction := .transactions }}
                                            <tr>
                                                <td>{{ PrettyDate $transaction.Date }}</td>
                                                <td>{{ $transaction.Title }}</td>
                                                <td class="text-right">{{ if isIncome $transaction.Ammount | not }}{{ printf "$%.2f" $transaction.Ammount }}{{ end }}</td>
                                                <td class="text-right">{{ if isIncome $transaction.Ammount }}{{ printf "$%.2f" $transaction.Ammount }}{{ end }}</td>
                                                <td>{{ Title $transaction.Who }}</td>
                                                <td>{{ Title $transaction.Category }}</td>
                                                <td>{{ Title $transaction.SecondaryCategory }}</td>
                                            </tr>
                                        {{ end }}
                                    </tbody>
                                </table>
                            {{ else }}
                                No recent transactions
                            {{ end }}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="modal fade" id="transactionModal" tabindex="-1" role="dialog">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                        <h4 class="modal-title" id="myModalLabel">Add Transaction</h4>
                    </div>
                    <div class="modal-body">
                        <form id="transactionForm" class="form-horizontal" action="/transaction" method="post">
                            <div class="form-group">
                                <label class="col-xs-4 control-label">Title</label>
                                <div class="col-xs-8">
                                    <input class="form-control" type="text" name="title">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="col-xs-4 control-label">Description</label>
                                <div class="col-xs-8">
                                    <input class="form-control" type="text" name="description">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="col-xs-4 control-label">Ammount</label>
                                <div class="col-xs-8">
                                    <input id="ammount" class="form-control" type="text" name="ammount">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="col-xs-4 control-label">Category</label>
                                <div class="col-xs-8">
                                    <div class="input-group">
                                        <select class="form-control category">
                                            <option value="">None</option>
                                            {{ range $category := OrderCategories .user.Categories }}
                                                <option value="{{ $category }}">{{ Title $category }}</option>
                                            {{ end }}
                                        </select>
                                        <input type="text" class="form-control hide category" name="category" value="">
                                        <span class="input-group-btn">
                                            <button class="btn btn-default category" type="button">Add</button>
                                        </span>
                                    </div>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="col-xs-4 control-label">Secondary Category</label>
                                <div class="col-xs-8">
                                    <div class="input-group">
                                        <select class="form-control category">
                                            <option value="">None</option>
                                            {{ range $category := OrderCategories .user.Categories }}
                                                <option value="{{ $category }}">{{ Title $category }}</option>
                                            {{ end }}
                                        </select>
                                        <input type="text" class="form-control hide category" name="secondaryCategory" value="">
                                        <span class="input-group-btn">
                                            <button class="btn btn-default category" type="button">Add</button>
                                        </span>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-lg-offset-1 col-lg-4">
                                    <a id="expense" class="btn btn-danger btn-block">Expense</a>
                                </div>
                                <div class="col-lg-offset-2 col-lg-4">
                                    <button class="btn btn-success btn-block">Income</button>
                                </div>
                            </div>
                            <input type="hidden" name="redirect" value="/transaction">
                        </form>
                    </div>
                </div>
            </div>
        </div>

        {{ template "scripts.tmpl" . }}

        {{ template "session.tmpl" . }}

        <script src="//cdn.datatables.net/1.10.13/js/jquery.dataTables.min.js" charset="utf-8"></script>
        <script src="/static/js/datatables-bootstrap.js" charset="utf-8"></script>
        <script src="/static/js/datatables-custom.js" charset="utf-8"></script>

        <script type="text/javascript">

            var category2 = [];

            $.fn.dataTable.ext.search.push(
                function( settings, data, dataIndex ) {

                    var aType = $('select#aType-filter').val();

                    if (aType == 'expense') {
                        var v = intVal(data[2])
                        if (v < 0) {
                            return true;
                        }
                        return false;
                    }

                    if (aType == 'income') {
                        var v = intVal(data[3]);
                        if (v > 0) {
                            return true;
                        }
                        return false;
                    }

                    return true;
                }
            );

            $.fn.dataTable.ext.search.push(
                function( settings, data, dataIndex ) {

                    var category = $('select#category1').val();
                    if (category == '') {
                        return true;
                    }

                    if (data[5] == category) {
                        if (data[6] != '') {
                            category2.push(data[6]);
                        }
                        return true;
                    }
                    if (data[6] == category) {
                        if (data[5] != '') {
                            category2.push(data[5]);
                        }
                        return true
                    }
                    return false;
                }
            );

            $.fn.dataTable.ext.search.push(
                function( settings, data, dataIndex ) {

                    var category = $('select#category2').val();
                    if (category == '') {
                        return true;
                    }

                    if (data[5] == category) {
                        return true;
                    }
                    if (data[6] == category) {
                        return true
                    }
                    return false;
                }
            );

            $.fn.dataTable.ext.search.push(
                function( settings, data, dataIndex ) {

                    var who = $('select#who').val();
                    if (who == '') {
                        return true;
                    }

                    if (data[4] == who) {
                        return true;
                    }
                    return false;
                }
            );



            $('select.filter').change(function() {
                table.draw()
            });

            var table = $('#transactions').DataTable({
                "lengthMenu":[10,15,20],
                "pageLength": 10,
                "columnDefs": [
                    { "name": "date",               "targets": 0 },
                    { "name": "title",              "targets": 1 },
                    { "name": "expense",            "targets": 2 },
                    { "name": "income",             "targets": 3 },
                    { "name": "who",                "targets": 4 },
                    { "name": "category",           "targets": 5 },
                    { "name": "secondaryCategory",  "targets": 6 }
                ],
                "footerCallback": function ( row, data, start, end, display ) {
                    var api = this.api(), data;

                    expenseTotal = api
                        .column(2, {search: 'applied'})
                        .data()
                        .reduce( function (a, b) {
                            return intVal(a) + intVal(b);
                        }, 0 );

                    // Total over this page
                    expenseSubTotal = api
                        .column(2, {page: 'current'})
                        .data()
                        .reduce(function(a, b) {
                            return intVal(a) + intVal(b);
                        }, 0);

                    // Update footer

                    $(api.column(2).footer()).html(
                        ((expenseSubTotal < 0) ? '<span class="pull-left">Sub Total: </span>$'+roundTo(expenseSubTotal, 2) : '') +
                        '<br>'+
                        ((expenseTotal < 0) ? '<span class="pull-left">Total: </span>$'+roundTo(expenseTotal, 2) : '')
                    );

                    incomeTotal = api
                        .column(3, {search: 'applied'})
                        .data()
                        .reduce( function (a, b) {
                            return intVal(a) + intVal(b);
                        }, 0 );

                    // Total over this page
                    incomeSubTotal = api
                        .column(3, {page: 'current'})
                        .data()
                        .reduce(function(a, b) {
                            return intVal(a) + intVal(b);
                        }, 0);

                    // Update footer
                    $(api.column(3).footer()).html(
                        ((incomeSubTotal > 0) ? '<span class="pull-left">Sub Total: </span>$'+roundTo(incomeSubTotal, 2) : '') +
                        '<br>' +
                        ((incomeTotal > 0) ? '<span class="pull-left">Total: </span>$'+roundTo(incomeTotal, 2) : '')
                    );
                }
            });

            table.on('search.dt', function() {
                if ($('select#category2').val() !== '') {
                    return;
                }

                if ($('select#category1').val() !== '') {
                    $.uniqueSort(category2).sort();
                } else {
                    category2 = [];
                }
                renderCategory2();
            });

            function intVal(i) {
                return typeof i === 'string' ?
                i.replace(/[\$,]/g, '')*1 :
                typeof i === 'number' ?
                i : 0;
            };

            function renderCategory2() {
                if ($('select#category1').val() == '') {
                    $('select#category2').html('<option></option>');
                    return;
                }
                var options = '<option value="">All</option>';
                for (var i = 0; i < category2.length; i++) {
                    options += '<option value="' + category2[i] + '">' + category2[i] + '</option>';
                }
                $('select#category2').html(options);
            }

        </script>


    </body>
</html>
